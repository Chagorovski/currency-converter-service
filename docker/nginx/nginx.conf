worker_processes  auto;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile on;
  tcp_nopush on;
  keepalive_timeout 65;

  # --- Compression ---
  gzip on;
  gzip_types text/plain text/css application/javascript application/json application/xml image/svg+xml;
  gzip_min_length 1024;
  gzip_vary on;

  server {
    listen 80;
    server_name _;

    # Symfony public dir inside image
    root /app/backend/public;
    index index.php index.html;

    # --- CSP (single line; no localhost) ---
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; script-src-elem 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; style-src-elem 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'none';" always;

    # --- Misc security headers ---
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;
    add_header Referrer-Policy no-referrer-when-downgrade always;

    # --- Size / timeouts ---
    client_max_body_size 4m;

    # --- Deny sensitive paths ---
    location ~* (^|/)\.(env|git|hg|svn) { deny all; }
    location = /composer.json            { deny all; }
    location = /composer.lock            { deny all; }

    # --- Long cache for built assets ---
    location ~* \.(?:js|css|mjs|map|png|jpg|jpeg|gif|svg|ico|webp|woff2?)$ {
      access_log off;
      expires 1y;
      add_header Cache-Control "public, max-age=31536000, immutable";
      try_files $uri =404;
    }

    # SPA build path (if you open http://localhost:8080/app/)
    location ^~ /app/ {
      try_files $uri $uri/ /app/index.html;
    }

    # API to PHP front controller
    location ^~ /api/ {
      try_files $uri /index.php$is_args$args;
    }

    # Redirect root to SPA (optional)
    location = / { return 302 /app/; }

    # PHP-FPM
    location ~ \.php$ {
      include        fastcgi_params;
      fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
      fastcgi_pass   127.0.0.1:9000;
      fastcgi_read_timeout 300;
    }
  }
}